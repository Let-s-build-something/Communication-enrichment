name: Build and extract Master

on:
  push:
    branches: [ "master" ]

jobs:
  sync:
    uses: ./.github/workflows/sync-with-gradle-files.yml
  compile:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
      # We need Java to build Android and Jvm
      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      # We need Xcode to build the iOS app
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 15.3

        # Prepare access to everything
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      - name: Decode Local properties
        run: echo "${{ secrets.LOCAL_PROPERTIES }}" | base64 --decode > /Users/runner/work/Communication-enrichment/Communication-enrichment/local.properties
      - name: Decode Keystore
        run: echo "${{ secrets.KEYSTORE }}" | base64 --decode > /Users/runner/work/keystore.jks
      - name: Decode google-services.json
        run: echo "${{ secrets.GOOGLE_SERVICES }}" | base64 --decode > /Users/runner/work/Communication-enrichment/Communication-enrichment/composeApp/google-services.json

      - name: Run Gradle tasks
        run: |
          ./gradlew :commonizeNativeDistribution
          ./gradlew :commonize
          ./gradlew :prepareKotlinIdeaImport
          ./gradlew :composeApp:generateDefFirebaseAuth
          ./gradlew :composeApp:xcodeVersion
          ./gradlew :composeApp:podGenIos
          ./gradlew :composeApp:podInstallSyntheticIos
          ./gradlew :composeApp:podSetupBuildFirebaseAuthIphoneos
          ./gradlew :composeApp:podBuildFirebaseAuthIphoneos
          ./gradlew :composeApp:cinteropFirebaseAuthIosArm64
          ./gradlew :composeApp:podSetupBuildFirebaseAuthIphonesimulator
          ./gradlew :composeApp:podBuildFirebaseAuthIphonesimulator
          ./gradlew :composeApp:cinteropFirebaseAuthIosSimulatorArm64
          ./gradlew :composeApp:cinteropFirebaseAuthIosX64
          ./gradlew :composeApp:generateDefFirebaseCore
          ./gradlew :composeApp:podSetupBuildFirebaseCoreIphoneos
          ./gradlew :composeApp:podBuildFirebaseCoreIphoneos
          ./gradlew :composeApp:cinteropFirebaseCoreIosArm64
          ./gradlew :composeApp:podSetupBuildFirebaseCoreIphonesimulator
          ./gradlew :composeApp:podBuildFirebaseCoreIphonesimulator
          ./gradlew :composeApp:cinteropFirebaseCoreIosSimulatorArm64
          ./gradlew :composeApp:cinteropFirebaseCoreIosX64
          ./gradlew :composeApp:generateDefFirebaseMessaging
          ./gradlew :composeApp:podSetupBuildFirebaseMessagingIphoneos
          ./gradlew :composeApp:podBuildFirebaseMessagingIphoneos
          ./gradlew :composeApp:cinteropFirebaseMessagingIosArm64
          ./gradlew :composeApp:podSetupBuildFirebaseMessagingIphonesimulator
          ./gradlew :composeApp:podBuildFirebaseMessagingIphonesimulator
          ./gradlew :composeApp:cinteropFirebaseMessagingIosSimulatorArm64
          ./gradlew :composeApp:cinteropFirebaseMessagingIosX64
          ./gradlew :composeApp:generateDefGoogleSignIn
          ./gradlew :composeApp:podSetupBuildGoogleSignInIphoneos
          ./gradlew :composeApp:podBuildGoogleSignInIphoneos
          ./gradlew :composeApp:cinteropGoogleSignInIosArm64
          ./gradlew :composeApp:podSetupBuildGoogleSignInIphonesimulator
          ./gradlew :composeApp:podBuildGoogleSignInIphonesimulator
          ./gradlew :composeApp:cinteropGoogleSignInIosSimulatorArm64
          ./gradlew :composeApp:cinteropGoogleSignInIosX64
          ./gradlew :composeApp:commonizeCInterop
          ./gradlew :composeApp:copyCommonizeCInteropForIde
          ./gradlew :composeApp:commonize
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidDebug
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidInstrumentedTest
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidInstrumentedTestDebug
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidMain
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidRelease
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidUnitTest
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidUnitTestDebug
          ./gradlew :composeApp:convertXmlValueResourcesForAndroidUnitTestRelease
          ./gradlew :composeApp:convertXmlValueResourcesForAppleMain
          ./gradlew :composeApp:convertXmlValueResourcesForAppleTest
          ./gradlew :composeApp:convertXmlValueResourcesForCommonMain
          ./gradlew :composeApp:convertXmlValueResourcesForCommonTest
          ./gradlew :composeApp:convertXmlValueResourcesForIosArm64Main
          ./gradlew :composeApp:convertXmlValueResourcesForIosArm64Test
          ./gradlew :composeApp:convertXmlValueResourcesForIosMain
          ./gradlew :composeApp:convertXmlValueResourcesForIosSimulatorArm64Main
          ./gradlew :composeApp:convertXmlValueResourcesForIosSimulatorArm64Test
          ./gradlew :composeApp:convertXmlValueResourcesForIosTest
          ./gradlew :composeApp:convertXmlValueResourcesForIosX64Main
          ./gradlew :composeApp:convertXmlValueResourcesForIosX64Test
          ./gradlew :composeApp:convertXmlValueResourcesForJvmMain
          ./gradlew :composeApp:convertXmlValueResourcesForJvmTest
          ./gradlew :composeApp:convertXmlValueResourcesForNativeMain
          ./gradlew :composeApp:convertXmlValueResourcesForNativeTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidDebug
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidInstrumentedTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidInstrumentedTestDebug
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidMain
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidRelease
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidUnitTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidUnitTestDebug
          ./gradlew :composeApp:copyNonXmlValueResourcesForAndroidUnitTestRelease
          ./gradlew :composeApp:copyNonXmlValueResourcesForAppleMain
          ./gradlew :composeApp:copyNonXmlValueResourcesForAppleTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForCommonMain
          ./gradlew :composeApp:copyNonXmlValueResourcesForCommonTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosArm64Main
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosArm64Test
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosMain
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosSimulatorArm64Main
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosSimulatorArm64Test
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosX64Main
          ./gradlew :composeApp:copyNonXmlValueResourcesForIosX64Test
          ./gradlew :composeApp:copyNonXmlValueResourcesForJvmMain
          ./gradlew :composeApp:copyNonXmlValueResourcesForJvmTest
          ./gradlew :composeApp:copyNonXmlValueResourcesForNativeMain
          ./gradlew :composeApp:copyNonXmlValueResourcesForNativeTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidMain
          ./gradlew :composeApp:generateResourceAccessorsForAndroidMain
          ./gradlew :composeApp:prepareComposeResourcesTaskForCommonMain
          ./gradlew :composeApp:generateResourceAccessorsForCommonMain
          ./gradlew :composeApp:generateActualResourceCollectorsForAndroidMain
          ./gradlew :composeApp:prepareComposeResourcesTaskForAppleMain
          ./gradlew :composeApp:generateResourceAccessorsForAppleMain
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosArm64Main
          ./gradlew :composeApp:generateResourceAccessorsForIosArm64Main
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosMain
          ./gradlew :composeApp:generateResourceAccessorsForIosMain
          ./gradlew :composeApp:prepareComposeResourcesTaskForNativeMain
          ./gradlew :composeApp:generateResourceAccessorsForNativeMain
          ./gradlew :composeApp:generateActualResourceCollectorsForIosArm64Main
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosSimulatorArm64Main
          ./gradlew :composeApp:generateResourceAccessorsForIosSimulatorArm64Main
          ./gradlew :composeApp:generateActualResourceCollectorsForIosSimulatorArm64Main
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosX64Main
          ./gradlew :composeApp:generateResourceAccessorsForIosX64Main
          ./gradlew :composeApp:generateActualResourceCollectorsForIosX64Main
          ./gradlew :composeApp:prepareComposeResourcesTaskForJvmMain
          ./gradlew :composeApp:generateResourceAccessorsForJvmMain
          ./gradlew :composeApp:generateActualResourceCollectorsForJvmMain
          ./gradlew :composeApp:generateAndroidDebugNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidInstrumentedTestDebugNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidInstrumentedTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidMainNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidReleaseNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidUnitTestDebugNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidUnitTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateAndroidUnitTestReleaseNonAndroidBuildConfig
          ./gradlew :composeApp:generateAppleMainNonAndroidBuildConfig
          ./gradlew :composeApp:generateAppleTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateComposeResClass
          ./gradlew :composeApp:generateExpectResourceCollectorsForCommonMain
          ./gradlew :composeApp:generateIosArm64MainNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosArm64TestNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosMainNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosSimulatorArm64MainNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosSimulatorArm64TestNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosX64MainNonAndroidBuildConfig
          ./gradlew :composeApp:generateIosX64TestNonAndroidBuildConfig
          ./gradlew :composeApp:generateJvmMainNonAndroidBuildConfig
          ./gradlew :composeApp:generateJvmTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateNativeMainNonAndroidBuildConfig
          ./gradlew :composeApp:generateNativeTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateNonAndroidBuildConfig
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidDebug
          ./gradlew :composeApp:generateResourceAccessorsForAndroidDebug
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidInstrumentedTest
          ./gradlew :composeApp:generateResourceAccessorsForAndroidInstrumentedTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidInstrumentedTestDebug
          ./gradlew :composeApp:generateResourceAccessorsForAndroidInstrumentedTestDebug
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidRelease
          ./gradlew :composeApp:generateResourceAccessorsForAndroidRelease
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidUnitTest
          ./gradlew :composeApp:generateResourceAccessorsForAndroidUnitTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidUnitTestDebug
          ./gradlew :composeApp:generateResourceAccessorsForAndroidUnitTestDebug
          ./gradlew :composeApp:prepareComposeResourcesTaskForAndroidUnitTestRelease
          ./gradlew :composeApp:generateResourceAccessorsForAndroidUnitTestRelease
          ./gradlew :composeApp:prepareComposeResourcesTaskForAppleTest
          ./gradlew :composeApp:generateResourceAccessorsForAppleTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForCommonTest
          ./gradlew :composeApp:generateResourceAccessorsForCommonTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosArm64Test
          ./gradlew :composeApp:generateResourceAccessorsForIosArm64Test
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosSimulatorArm64Test
          ./gradlew :composeApp:generateResourceAccessorsForIosSimulatorArm64Test
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosTest
          ./gradlew :composeApp:generateResourceAccessorsForIosTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForIosX64Test
          ./gradlew :composeApp:generateResourceAccessorsForIosX64Test
          ./gradlew :composeApp:prepareComposeResourcesTaskForJvmTest
          ./gradlew :composeApp:generateResourceAccessorsForJvmTest
          ./gradlew :composeApp:prepareComposeResourcesTaskForNativeTest
          ./gradlew :composeApp:generateResourceAccessorsForNativeTest
          ./gradlew :composeApp:generateTestNonAndroidBuildConfig
          ./gradlew :composeApp:generateDummyFramework
          ./gradlew :composeApp:podspec
          ./gradlew :composeApp:podInstall
          ./gradlew :composeApp:podImport
          ./gradlew :composeApp:transformNativeMainCInteropDependenciesMetadataForIde
          ./gradlew :composeApp:transformAppleMainCInteropDependenciesMetadataForIde
          ./gradlew :composeApp:transformIosMainCInteropDependenciesMetadataForIde
          ./gradlew :composeApp:transformNativeTestCInteropDependenciesMetadataForIde
          ./gradlew :composeApp:transformAppleTestCInteropDependenciesMetadataForIde
          ./gradlew :composeApp:transformIosTestCInteropDependenciesMetadataForIde
          ./gradlew :composeApp:prepareKotlinIdeaImport
          ./gradlew :shared:commonizeCInterop
          ./gradlew :shared:copyCommonizeCInteropForIde
          ./gradlew :shared:commonize
          ./gradlew :shared:convertXmlValueResourcesForAndroidDebug
          ./gradlew :shared:convertXmlValueResourcesForAndroidInstrumentedTest
          ./gradlew :shared:convertXmlValueResourcesForAndroidInstrumentedTestDebug
          ./gradlew :shared:convertXmlValueResourcesForAndroidMain
          ./gradlew :shared:convertXmlValueResourcesForAndroidRelease
          ./gradlew :shared:convertXmlValueResourcesForAndroidUnitTest
          ./gradlew :shared:convertXmlValueResourcesForAndroidUnitTestDebug
          ./gradlew :shared:convertXmlValueResourcesForAndroidUnitTestRelease
          ./gradlew :shared:convertXmlValueResourcesForAppleMain
          ./gradlew :shared:convertXmlValueResourcesForAppleTest
          ./gradlew :shared:convertXmlValueResourcesForCommonMain
          ./gradlew :shared:convertXmlValueResourcesForCommonTest
          ./gradlew :shared:convertXmlValueResourcesForIosArm64Main
          ./gradlew :shared:convertXmlValueResourcesForIosArm64Test
          ./gradlew :shared:convertXmlValueResourcesForIosMain
          ./gradlew :shared:convertXmlValueResourcesForIosSimulatorArm64Main
          ./gradlew :shared:convertXmlValueResourcesForIosSimulatorArm64Test
          ./gradlew :shared:convertXmlValueResourcesForIosTest
          ./gradlew :shared:convertXmlValueResourcesForIosX64Main
          ./gradlew :shared:convertXmlValueResourcesForIosX64Test
          ./gradlew :shared:convertXmlValueResourcesForJvmMain
          ./gradlew :shared:convertXmlValueResourcesForJvmTest
          ./gradlew :shared:convertXmlValueResourcesForNativeMain
          ./gradlew :shared:convertXmlValueResourcesForNativeTest
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidDebug
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidInstrumentedTest
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidInstrumentedTestDebug
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidMain
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidRelease
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidUnitTest
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidUnitTestDebug
          ./gradlew :shared:copyNonXmlValueResourcesForAndroidUnitTestRelease
          ./gradlew :shared:copyNonXmlValueResourcesForAppleMain
          ./gradlew :shared:copyNonXmlValueResourcesForAppleTest
          ./gradlew :shared:copyNonXmlValueResourcesForCommonMain
          ./gradlew :shared:copyNonXmlValueResourcesForCommonTest
          ./gradlew :shared:copyNonXmlValueResourcesForIosArm64Main
          ./gradlew :shared:copyNonXmlValueResourcesForIosArm64Test
          ./gradlew :shared:copyNonXmlValueResourcesForIosMain
          ./gradlew :shared:copyNonXmlValueResourcesForIosSimulatorArm64Main
          ./gradlew :shared:copyNonXmlValueResourcesForIosSimulatorArm64Test
          ./gradlew :shared:copyNonXmlValueResourcesForIosTest
          ./gradlew :shared:copyNonXmlValueResourcesForIosX64Main
          ./gradlew :shared:copyNonXmlValueResourcesForIosX64Test
          ./gradlew :shared:copyNonXmlValueResourcesForJvmMain
          ./gradlew :shared:copyNonXmlValueResourcesForJvmTest
          ./gradlew :shared:copyNonXmlValueResourcesForNativeMain
          ./gradlew :shared:copyNonXmlValueResourcesForNativeTest
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidMain
          ./gradlew :shared:generateResourceAccessorsForAndroidMain
          ./gradlew :shared:prepareComposeResourcesTaskForCommonMain
          ./gradlew :shared:generateResourceAccessorsForCommonMain
          ./gradlew :shared:generateActualResourceCollectorsForAndroidMain
          ./gradlew :shared:prepareComposeResourcesTaskForAppleMain
          ./gradlew :shared:generateResourceAccessorsForAppleMain
          ./gradlew :shared:prepareComposeResourcesTaskForIosArm64Main
          ./gradlew :shared:generateResourceAccessorsForIosArm64Main
          ./gradlew :shared:prepareComposeResourcesTaskForIosMain
          ./gradlew :shared:generateResourceAccessorsForIosMain
          ./gradlew :shared:prepareComposeResourcesTaskForNativeMain
          ./gradlew :shared:generateResourceAccessorsForNativeMain
          ./gradlew :shared:generateActualResourceCollectorsForIosArm64Main
          ./gradlew :shared:prepareComposeResourcesTaskForIosSimulatorArm64Main
          ./gradlew :shared:generateResourceAccessorsForIosSimulatorArm64Main
          ./gradlew :shared:generateActualResourceCollectorsForIosSimulatorArm64Main
          ./gradlew :shared:prepareComposeResourcesTaskForIosX64Main
          ./gradlew :shared:generateResourceAccessorsForIosX64Main
          ./gradlew :shared:generateActualResourceCollectorsForIosX64Main
          ./gradlew :shared:prepareComposeResourcesTaskForJvmMain
          ./gradlew :shared:generateResourceAccessorsForJvmMain
          ./gradlew :shared:generateActualResourceCollectorsForJvmMain
          ./gradlew :shared:generateComposeResClass
          ./gradlew :shared:generateExpectResourceCollectorsForCommonMain
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidDebug
          ./gradlew :shared:generateResourceAccessorsForAndroidDebug
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidInstrumentedTest
          ./gradlew :shared:generateResourceAccessorsForAndroidInstrumentedTest
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidInstrumentedTestDebug
          ./gradlew :shared:generateResourceAccessorsForAndroidInstrumentedTestDebug
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidRelease
          ./gradlew :shared:generateResourceAccessorsForAndroidRelease
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidUnitTest
          ./gradlew :shared:generateResourceAccessorsForAndroidUnitTest
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidUnitTestDebug
          ./gradlew :shared:generateResourceAccessorsForAndroidUnitTestDebug
          ./gradlew :shared:prepareComposeResourcesTaskForAndroidUnitTestRelease
          ./gradlew :shared:generateResourceAccessorsForAndroidUnitTestRelease
          ./gradlew :shared:prepareComposeResourcesTaskForAppleTest
          ./gradlew :shared:generateResourceAccessorsForAppleTest
          ./gradlew :shared:prepareComposeResourcesTaskForCommonTest
          ./gradlew :shared:generateResourceAccessorsForCommonTest
          ./gradlew :shared:prepareComposeResourcesTaskForIosArm64Test
          ./gradlew :shared:generateResourceAccessorsForIosArm64Test
          ./gradlew :shared:prepareComposeResourcesTaskForIosSimulatorArm64Test
          ./gradlew :shared:generateResourceAccessorsForIosSimulatorArm64Test
          ./gradlew :shared:prepareComposeResourcesTaskForIosTest
          ./gradlew :shared:generateResourceAccessorsForIosTest
          ./gradlew :shared:prepareComposeResourcesTaskForIosX64Test
          ./gradlew :shared:generateResourceAccessorsForIosX64Test
          ./gradlew :shared:prepareComposeResourcesTaskForJvmTest
          ./gradlew :shared:generateResourceAccessorsForJvmTest
          ./gradlew :shared:prepareComposeResourcesTaskForNativeTest
          ./gradlew :shared:generateResourceAccessorsForNativeTest
          ./gradlew :shared:generateDummyFramework
          ./gradlew :shared:podspec
          ./gradlew :shared:podInstall
          ./gradlew :shared:podImport
          ./gradlew :shared:transformNativeMainCInteropDependenciesMetadataForIde
          ./gradlew :shared:transformAppleMainCInteropDependenciesMetadataForIde
          ./gradlew :shared:transformIosMainCInteropDependenciesMetadataForIde
          ./gradlew :shared:transformNativeTestCInteropDependenciesMetadataForIde
          ./gradlew :shared:transformAppleTestCInteropDependenciesMetadataForIde
          ./gradlew :shared:transformIosTestCInteropDependenciesMetadataForIde
          ./gradlew :shared:prepareKotlinIdeaImport
          ./gradlew :prepareKotlinBuildScriptModel


        # Prepare Apple certificates
      - name: Import Apple certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_P12_PASSWORD }}

        # Download provisioning profiles
      - name: Download Apple provisioning profiles
        uses: apple-actions/download-provisioning-profiles@v2
        with:
          bundle-id: ${{ secrets.APPLE_BUNDLE_ID }}
          issuer-id: ${{ secrets.APP_STORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_KEY_ID }}
          api-private-key: ${{ secrets.APP_STORE_PRIVATE_KEY }}

        # Prepare the environment
      - name: Build with Gradle and Print Version
        id: gradle
        run: |
          VERSION=$(./gradlew -q printVersionName)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

        # Build the app and export the output files

        # iOS - create .ipa file
      - name: Build archive
        run: |
          cd iosApp
          
          pod install
          
          xcrun xcodebuild \
            -scheme "iosApp" \
            -configuration "Release" \
            -sdk "iphoneos" \
            -parallelizeTargets \
            -showBuildTimingSummary \
            -disableAutomaticPackageResolution \
            -derivedDataPath "${RUNNER_TEMP}/Build/DerivedData" \
            -archivePath "${RUNNER_TEMP}/Build/Archives/iosApp.xcarchive" \
            -resultBundlePath "${RUNNER_TEMP}/Build/Artifacts/iosApp.xcresult" \
            -destination "generic/platform=iOS" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            PRODUCT_BUNDLE_IDENTIFIER="${{ secrets.APPLE_BUNDLE_ID }}" \
            CODE_SIGN_STYLE="Manual" \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.APPLE_PROVISIONING_PROFILE_NAME }}" \
            archive 

      - name: Generate ExportOptions.plist
        run: |
          cat <<EOF > ${RUNNER_TEMP}/Build/ExportOptions.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>destination</key>
              <string>export</string>
              <key>method</key>
              <string>app-store</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>generateAppStoreInformation</key>
              <true/>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>uploadSymbols</key>
              <true/>
              <key>provisioningProfiles</key>
              <dict>
                <key>${{ secrets.APPLE_BUNDLE_ID }}</key>
                <string>${{ secrets.APPLE_PROVISIONING_PROFILE_NAME_DIST }}</string>
              </dict>
            </dict>
          </plist>
          EOF
      - id: export_archive
        name: export archive
        run: |
          xcrun xcodebuild \
            -exportArchive \
            -exportOptionsPlist "${RUNNER_TEMP}/Build/ExportOptions.plist" \
            -archivePath "${RUNNER_TEMP}/Build/Archives/iosApp.xcarchive" \
            -exportPath "${RUNNER_TEMP}/Build/Archives/iosApp.xcarchive" \
            PRODUCT_BUNDLE_IDENTIFIER="${{ secrets.APPLE_BUNDLE_ID }}"

      - name: Export Windows .app to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-release
          path: ${RUNNER_TEMP}/Build/Archives/iosApp.xcarchive/iosApp.ipa

        # Windows - Msi
      - name: Build Windows Release
        run: ./gradlew packageReleaseMsi
      - name: Export Windows .app to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Windows ${{ env.VERSION }}
          path: ${{ github.workspace }}/composeApp/build/compose/binaries/main-release/app/Chatrich.app

        # Linux - Deb
      - name: Build Linux Release
        run: ./gradlew packageReleaseDeb

        # Android - create a bundle
      - name: Build Android Release
        run: ./gradlew bundleRelease
      - name: Export Android .aab to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release
          path: ${{ github.workspace }}/composeApp/build/outputs/bundle/release/composeApp-release.aab

  deploy:
    uses: ./.github/workflows/artifact-distribution.yml
    needs: compile